<!DOCTYPE html>

<meta charset="utf-8">
<body>



<div class="Aligner">
  <div class="Aligner-item Aligner-item--top"></div>
  <div id="div_svg" class="Aligner-item"></div>
  <div class="Aligner-item Aligner-item--bottom"></div>
</div>


<link rel="stylesheet" type="text/css" href="a.css">
<script src="lib/d3/d3.js"></script>
<script src="js/d3.layout.cloud.js"></script>
<script src="js/imgur.js"></script>
<script>
  var fill = d3.scale.category20();


  var svg_height = 500;
  var svg_width = 800;

  var div_svg = d3.select("#div_svg");
  var svg = div_svg.append("svg");

  svg.style("background","white");


  function onMouseIn(d) {
    var i = d3.select(this);
    i.select("rect")
          .transition()
          .duration(200)
          .attr('x', d.x-16)
          .attr('y', d.y-8)
          .attr('width', d.w+32)
          .attr('height', d.h+16);

    i.select(".vs-img-left")
          .transition()
          .duration(200)
          .attr('x', d.x-14)
          .attr('y', d.y-6)
          .attr('width', (d.w+28)/2-1)
          .attr('height', d.h+12);

    i.select(".vs-img-right")
          .transition()
          .duration(200)
          .attr('x', d.x-14 + (d.w+28)/2)
          .attr('y', d.y-6)
          .attr('width', (d.w+28)/2-1)
          .attr('height', d.h+12);
    i.moveToFront();
  }

  function onMouseOut(d) {
    var i = d3.select(this);
    i.select("rect")
          .transition()
          .duration(200)
          .attr('x', d.x)
          .attr('y', d.y)
          .attr('width', d.w)
          .attr('height', d.h);

    i.select(".vs-img-left")
          .transition()
          .duration(200)
          .attr('x', d.x+2)
          .attr('y', d.y+2)
          .attr('width', (d.w-4)/2-1)
          .attr('height', d.h-4);

    i.select(".vs-img-right")
          .transition()
          .duration(200)
          .attr('x', d.x+4 + (d.w-4)/2)
          .attr('y', d.y+2)
          .attr('width', (d.w-4)/2-1)
          .attr('height', d.h-4);
  }

  function draw(vs_bins) {
      var borderPath = svg.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("height", svg_height)
          .attr("width", svg_width)
          .style("stroke", "green")
          .style("fill", "none")
          .style("stroke-width", 2);

      var gradient = svg.append("svg:defs")
          .append("svg:linearGradient")
          .attr("id", "gradient")
          .attr("x1", "0%")
          .attr("y1", "0%")
          .attr("x2", "100%")
          .attr("y2", "0%")
          .attr("spreadMethod", "pad");

      gradient.append("svg:stop")
          .attr("offset", "0%")
          .attr("stop-color", "#25BADF")
          .attr("stop-opacity", 1);

      gradient.append("svg:stop")
          .attr("offset", "50%")
          .attr("stop-color", "#F98829")
          .attr("stop-opacity", 1);

      gradient.append("svg:stop")
          .attr("offset", "100%")
          .attr("stop-color", "#CE173E")
          .attr("stop-opacity", 1);

      var g = svg.attr("width",  svg_width)
                 .attr("height", svg_height)
                 .append("g")
                   .attr("transform", "translate("+svg_width/2+","+svg_height/2+")");

      vs_rects = g.selectAll("rect")
                  .data(vs_bins)
                    .enter()
                      .append("g")
                        .on("mouseover", onMouseIn)
                        .on("mouseout", onMouseOut);
      vs_rects.append("svg:image")
                .attr("x", function(d) { console.log("img: ", d); return d.x+2; })
                .attr("y", function(d) { return d.y+2; })
                .attr("width", function(d) { return (d.w-4)/2-1; })
                .attr("height", function(d) { return d.h-4; })
                .attr("xlink:href",function(d) { return d.imgleft; })
                .attr('class', 'vs-img-left');
      vs_rects.append("svg:image")
                .attr("x", function(d) { console.log("img: ", d); return d.x+4 + (d.w-4)/2; })
                .attr("y", function(d) { return d.y+2; })
                .attr("width", function(d) { return (d.w-4)/2-1; })
                .attr("height", function(d) { return d.h-4; })
                .attr("xlink:href",function(d) { return d.imgright; })
                .attr('class', 'vs-img-right');
      vs_rects.append("svg:rect")
              .attr("x", function(d) { return d.x+2; })
              .attr("y", function(d) { return d.y+2; })
              .attr("rx", function(d) { return d.h*0.04; })
              .attr("ry", function(d) { return d.h*0.04; })
              .attr("width", function(d) { return d.w-2; })
              .attr("height", function(d) { return d.h-2; })
              .style("stroke", "url(#gradient)")
              .style("stroke-width", 4)
              .attr("fill", "transparent");
  }

  function startAll() {
    var iid = 0;
    var vs_data = [
          "Hello", "world", "normally", "you", "want", "more", "words",
          "Hello", "world", "normally", "you", "want", "more", "words",
          "than", "this", "Hello", "world", "normally", "you", "want", "more", "words",
           "Hello", "world", "normally", "you", "want", "more", "words"].map(function(d) {
          return {text: d, 
                  dim: 80 + Math.random() * 80, 
                  imgleft: Imgur.imgurls[iid++],
                  imgright: Imgur.imgurls[iid++]};
        });

    d3.layout.cloud().size([svg_width, svg_height])
        .vs_bins(vs_data)
        .padding(5)
        .on("end", draw)
        .start();
  }

  Imgur.fetch(60, startAll);


</script>
</body>
